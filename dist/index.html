<!DOCTYPE html>
<html>
  <head>
    <title>Shrughouse.ts</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.0.3/tailwind.min.css"
    />
    <style>
      #name-form {
        display: none;
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: white;
      }

      #name-input {
        position: fixed;
        font-size: 200%;
        top: calc(50% - 1em);
        left: calc(50% - 8em);
        width: 16em;
        height: 2em;
        margin: 0;
        text-align: center;
        border: 1px solid #bbb;
      }

      #name-form p {
        position: fixed;
        top: calc(50% + 3em);
        width: 100%;
        text-align: center;
      }

      #room-form {
        display: none;
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: white;
        font-size: 200%;
        margin-top: calc(50vh - 3em);
        text-align: center;
      }

      #room-name {
        font-size: inherit;
        border: 1px solid #bbb;
        height: 2em;
        width: 16em;
        padding-left: 1em;
      }

      #room-form button {
        font-size: inherit;
        border: 1px solid #bbb;
        background-color: #eee;
        height: 2em;
      }

      #room {
        display: none;
      }

      #go-public {
        width: 4em;
      }
      #go-private {
        width: 20em;
      }

      #video-container {
        position: relative;
        z-index: 20;
      }

      .container {
        display: flex;
      }
    </style>
  </head>
  <body>
    <form id="room-form">
      <p>Enter a public room:</p>
      <input id="room-name" placeholder="room name" /><button id="go-public">
        Go &raquo;
      </button>
    </form>

    <form id="name-form">
      <input id="name-input" placeholder="your name" />
    </form>

    <form id="room">
      <div id="video-container">
        <div id="videos" class="container"></div>
      </div>
    </form>

    <script>
      function app() {
        const zuckHouse = Shrughouse();

        const createVideo = (id, src) => {
          if (!document.querySelector(`#${id}`)) {
            let newVid = document.createElement('video');

            newVid.srcObject = src;
            newVid.id = id;
            newVid.playsinline = false;
            newVid.autoplay = true;
            newVid.className = 'vid';

            if (id === 'user') {
              newVid.muted = true;
            }

            videos.appendChild(newVid);
          }
        };

        const removeVideo = (id) => {
          const videoEl = document.querySelector(`#${id}`);

          if (videoEl) {
            const tracks = videoEl.srcObject.getTracks();

            tracks.forEach(function (track) {
              track.stop();
            });

            videoEl.srcObject = null;
            videoEl.parentNode.removeChild(videoEl);
          }
        };

        zuckHouse.on('user', function (event) {
          const type = event.type;
          const user = event.detail;

          if (type === 'update') {
            if (user.stream) {
              createVideo('user', user.stream);
            } else {
              removeVideo('user');
            }
          }
        });

        zuckHouse.on('media', function (event) {
          const type = event.type;
          const stream = event.detail;

          const videos = document.querySelector('#videos');

          if (type === 'add') {
            createVideo(`stream-${stream.id}`, stream.stream);
          } else {
            removeVideo(`stream-${stream.id}`);
          }
        });

        function startRoom(name) {
          let room = document.querySelector('#room');

          if (name.length > 0) {
            zuckHouse.room.set({
              name: name,
            });

            zuckHouse.room.start();

            room.style.display = 'block';
          }
        }

        function roomChooser() {
          let roomForm = document.querySelector('#room-form');
          let roomNameInput = document.querySelector('#room-name');
          let goPublicButton = document.querySelector('#go-public');
          let goPrivateButton = document.querySelector('#go-private');

          roomForm.style.display = 'block';

          const showNameChooser = (name) => {
            roomForm.style.display = 'none';

            document.location.hash = name;
            nameChooser(name);
          };

          if (document.location.hash.length > 1) {
            showNameChooser(document.location.hash.slice(1));

            return;
          }

          roomForm.addEventListener('submit', (event) => {
            event.preventDefault();

            showNameChooser(roomNameInput.value);
          });

          roomNameInput.addEventListener('input', (event) => {
            if (event.currentTarget.value.length > 32) {
              event.currentTarget.value = event.currentTarget.value.slice(
                0,
                32
              );
            }
          });

          goPublicButton.addEventListener('click', (event) => {
            showNameChooser(roomNameInput.value);
          });

          roomNameInput.focus();
        }

        function nameChooser(roomName) {
          let nameForm = document.querySelector('#name-form');
          let nameInput = document.querySelector('#name-input');

          nameForm.style.display = 'block';

          nameForm.addEventListener('submit', (event) => {
            event.preventDefault();

            if (nameInput.value.length > 0) {
              zuckHouse.user.set({
                name: nameInput.value,
              });

              nameForm.style.display = 'none';
              startRoom(roomName);
            }
          });

          nameInput.addEventListener('input', (event) => {
            if (event.currentTarget.value.length > 32) {
              event.currentTarget.value = event.currentTarget.value.slice(
                0,
                32
              );
            }
          });

          nameInput.focus();
        }

        roomChooser();

        document.querySelector('#name-form').appendChild(
          zuckHouse.components.Modal({
            title: 'Vanilla title',
          })
        );
      }

      window.onload = () => {
        app();
      };
    </script>
  <script src="/scripts/app.js"></script></body>
</html>
