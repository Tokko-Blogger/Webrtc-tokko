<!DOCTYPE html>
<html>
  <head>
    <title>Shrughouse.ts</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.0.3/tailwind.min.css"
    />
    <style>
      #room {
        display: none;
      }

      #video-container {
        position: relative;
        z-index: 20;
      }

      .container {
        display: flex;
      }
    </style>
  </head>
  <body class="bg-yellow-50">
    <div id="vanilla-root"></div>

    <form id="room">
      <div id="video-container">
        <div id="videos" class="container"></div>
      </div>
    </form>

    <script>
      function app() {
        const zuckHouse = Shrughouse();

        const createMedia = (id, type, src) => {
          if (!document.querySelector(`#${id}`)) {
            let newVid = document.createElement(type || 'video');

            newVid.srcObject = src;
            newVid.id = id;
            newVid.playsinline = false;
            newVid.autoplay = true;
            newVid.className = 'vid';

            if (id === 'user') {
              newVid.muted = true;
            }

            videos.appendChild(newVid);
          }
        };

        const removeMedia = (id) => {
          const videoEl = document.querySelector(`#${id}`);

          if (videoEl) {
            const tracks = videoEl.srcObject.getTracks();

            tracks.forEach(function (track) {
              track.stop();
            });

            videoEl.srcObject = null;
            videoEl.parentNode.removeChild(videoEl);
          }
        };

        zuckHouse.on('user', function (event) {
          const type = event.type;
          const user = event.detail;

          if (type === 'update') {
            if (user.stream) {
              createMedia('user', user.streamType, user.stream);
            } else {
              removeMedia('user');
            }
          }
        });

        zuckHouse.on('media', function (event) {
          const type = event.type;
          const stream = event.detail;

          const videos = document.querySelector('#videos');

          if (type === 'add') {
            createMedia(
              `stream-${stream.id}`,
              stream.streamType,
              stream.stream
            );
          } else if (type === 'remove') {
            removeMedia(`stream-${stream.id}`);
          } else {
            // mute
          }
        });

        zuckHouse.on('room:member', function (event) {
          console.log('room member', event);
        });

        function setRoot(el) {
          const root = document.querySelector('#vanilla-root');

          root.innerHTML = '';
          root.appendChild(el);
        }

        function startRoom(name) {
          let room = document.querySelector('#room');

          if (name.length > 0) {
            zuckHouse.room.set({
              name: name,
            });

            zuckHouse.room.start();

            room.style.display = 'block';
          }
        }

        function roomChooser() {
          const showNameChooser = (name) => {
            document.location.hash = name;

            nameChooser(name);
          };

          if (document.location.hash.length > 1) {
            showNameChooser(document.location.hash.slice(1));

            return;
          }

          setRoot(
            zuckHouse.components.Panel({
              children: [
                zuckHouse.components.Form({
                  title: 'Enter room name',
                  placeholderText: 'room name',
                  actionText: 'continue',
                  onSubmit(event) {
                    event.preventDefault();

                    const form = event.target;

                    let value = form.querySelector('input').value;
                    if (value.length > 32) {
                      value = value.slice(0, 32);
                    }

                    showNameChooser(value);
                  },
                }),
              ],
            })
          );
        }

        function nameChooser(roomName) {
          setRoot(
            zuckHouse.components.Panel({
              children: [
                zuckHouse.components.Form({
                  title: 'Enter your name',
                  placeholderText: 'your name',
                  actionText: 'enter',
                  onSubmit(event) {
                    event.preventDefault();

                    const form = event.target;

                    let value = form.querySelector('input').value;

                    if (value.length > 0) {
                      zuckHouse.user.set({
                        name: value,
                      });

                      startRoom(roomName);
                    }
                  },
                }),
              ],
            })
          );
        }

        roomChooser();
      }

      window.onload = () => {
        app();
      };
    </script>
  </body>
</html>
